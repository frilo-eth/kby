<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gauge Chart - Liquidity Range</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Inter', sans-serif;
      background: #fafafa;
      min-height: 100vh;
      padding: 2rem;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .container {
      max-width: 1200px;
      width: 100%;
      background: white;
      border-radius: 12px;
      border: 1px solid #e5e7eb;
      overflow: hidden;
    }
    .header {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 1.5rem;
      border-bottom: 1px solid #e5e7eb;
    }
    h1 {
      font-size: 1.125rem;
      color: #1f2937;
      font-weight: 600;
      flex: 1;
    }
    .token-pair {
      font-size: 0.9375rem;
      color: #6b7280;
    }
    .content {
      display: grid;
      grid-template-columns: 1.5fr 1fr;
      gap: 2rem;
      padding: 2rem;
    }
    .chart-section {
      display: flex;
      flex-direction: column;
    }
    .metrics {
      display: flex;
      gap: 2rem;
      margin-bottom: 2rem;
    }
    .metric { flex: 1; }
    .metric-label {
      font-size: 0.8125rem;
      color: #9ca3af;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 0.25rem;
    }
    .metric-value {
      font-size: 1.5rem;
      font-weight: 600;
      color: #1f2937;
    }
    .metric-support {
      font-size: 0.8125rem;
      color: #9ca3af;
      margin-top: 0.125rem;
    }
    .gauge-wrapper {
      position: relative;
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #gaugeCanvas {
      display: block;
      width: 100%;
      max-width: 500px;
      height: 300px;
      cursor: grab;
    }
    #gaugeCanvas:active { cursor: grabbing; }
    .inputs-section {
      background: #fafafa;
      border-radius: 10px;
      padding: 1.5rem;
      border: 1px solid #e5e7eb;
    }
    .section-title {
      font-size: 0.875rem;
      font-weight: 600;
      color: #1f2937;
      margin-bottom: 1rem;
    }
    .input-group { margin-bottom: 1rem; }
    .input-label {
      font-size: 0.8125rem;
      color: #6b7280;
      margin-bottom: 0.5rem;
      display: block;
    }
    .input-wrapper {
      display: flex;
      align-items: center;
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 0.75rem;
    }
    .input-wrapper input {
      flex: 1;
      background: none;
      border: none;
      font-size: 0.9375rem;
      color: #1f2937;
      outline: none;
      font-weight: 500;
    }
    .input-wrapper .token {
      color: #9ca3af;
      font-size: 0.875rem;
      margin-left: 0.5rem;
    }
    .input-usd {
      font-size: 0.75rem;
      color: #9ca3af;
      margin-top: 0.25rem;
      display: block;
    }
    .percentage-btns {
      display: flex;
      gap: 0.5rem;
      margin-top: 0.5rem;
    }
    .percentage-btns button {
      flex: 1;
      padding: 0.5rem;
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      font-size: 0.75rem;
      color: #6b7280;
      cursor: pointer;
      transition: all 0.2s;
      font-weight: 500;
    }
    .percentage-btns button:hover {
      background: #f9fafb;
      border-color: #9ca3af;
    }
    .ratio-info {
      display: flex;
      justify-content: space-between;
      font-size: 0.875rem;
      color: #6b7280;
      margin: 0.75rem 0;
    }
    .total-section {
      margin-top: 1.5rem;
      padding-top: 1.5rem;
      border-top: 1px solid #e5e7eb;
    }
    .total-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.5rem;
    }
    .total-label { font-size: 0.875rem; color: #6b7280; }
    .total-value {
      font-size: 1.125rem;
      font-weight: 600;
      color: #1f2937;
    }
    .add-btn {
      width: 100%;
      padding: 1rem;
      background: #10b981;
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 0.9375rem;
      font-weight: 600;
      cursor: pointer;
      margin-top: 1rem;
      transition: background 0.2s;
    }
    .add-btn:hover { background: #059669; }
    .apr-indicator {
      width: 12px; height: 12px; border-radius: 50%;
      background: #d1d5db; transition: all 0.3s;
    }
    .apr-indicator.active {
      background: #10b981;
      box-shadow: 0 0 12px rgba(16,185,129,0.6);
      animation: pulse 2s ease-in-out infinite;
    }
    @keyframes pulse { 0%,100%{opacity:1;} 50%{opacity:.6;} }
    .apr-status { font-size:0.8125rem; margin-left:0.5rem; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Add Liquidity</h1><span class="token-pair">WETH / USDT</span>
    </div>

    <div class="content">
      <div class="chart-section">
        <div class="metrics">
          <div class="metric"><div class="metric-label">Min Price</div><div class="metric-value" id="minPrice">3165.29</div><div class="metric-support" id="minPriceUsd">$3,165.29</div></div>
          <div class="metric"><div class="metric-label">Balance</div><div class="metric-value" id="balancePercent">100%</div><div class="metric-support" id="balanceUsd">$0</div></div>
          <div class="metric"><div class="metric-label">Max Price</div><div class="metric-value" id="maxPrice">3261.68</div><div class="metric-support" id="maxPriceUsd">$3,261.68</div></div>
          <div class="metric"><div class="metric-label">Estimated APR</div><div class="metric-value"><div style="display:flex;align-items:center;"><span class="apr-indicator" id="aprIndicator"></span><span id="apr">127.20%</span></div></div><div class="metric-support apr-status" id="aprStatus">✓ In range</div></div>
        </div>
        <div class="gauge-wrapper"><canvas id="gaugeCanvas"></canvas></div>
      </div>

      <div class="inputs-section">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
          <h3 style="font-size: 1rem; font-weight: 600; color: #111827;">Add deposit amount</h3>
          <div style="font-size: 0.75rem; color: #6b7280; padding: 4px 8px; background: #f3f4f6; border-radius: 6px;">1.5%</div>
        </div>
        
        <!-- WETH Input -->
        <div style="border: 1px solid #e5e7eb; background: white; border-radius: 10px; padding: 14px; margin-bottom: 8px;">
          <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
            <div style="display: flex; align-items: center; gap: 8px;">
              <div style="width: 28px; height: 28px; background: #1f2937; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 12px; font-weight: bold;">Ξ</div>
              <span style="font-weight: 600; font-size: 0.9375rem; color: #111827;">WETH</span>
            </div>
            <input 
              type="number" 
              id="wethInput"
              value="1.00"
              step="0.01"
              style="font-size: 1.375rem; font-weight: 700; text-align: right; background: transparent; border: none; outline: none; width: 140px; color: #111827;"
            />
          </div>
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <div style="display: flex; gap: 4px;">
              <button onclick="setMultiplier(0)" style="font-size: 0.6875rem; padding: 3px 10px; background: #f9fafb; border-radius: 5px; border: 1px solid #e5e7eb; cursor: pointer; color: #6b7280; font-weight: 500;">0</button>
              <button onclick="setMultiplier(0.5)" style="font-size: 0.6875rem; padding: 3px 10px; background: #f9fafb; border-radius: 5px; border: 1px solid #e5e7eb; cursor: pointer; color: #6b7280; font-weight: 500;">50%</button>
              <button onclick="setMultiplier(1.0)" style="font-size: 0.6875rem; padding: 3px 10px; background: #f9fafb; border-radius: 5px; border: 1px solid #e5e7eb; cursor: pointer; color: #6b7280; font-weight: 500;">MAX</button>
            </div>
            <span style="font-size: 0.8125rem; color: #9ca3af; font-weight: 500;" id="wethUsd">$3,210</span>
          </div>
        </div>
        
        <!-- Plus button -->
        <div style="display: flex; justify-content: center; margin: 12px 0;">
          <div style="width: 40px; height: 40px; border-radius: 50%; background: #f3f4f6; display: flex; align-items: center; justify-content: center; font-size: 20px; color: #6b7280;">+</div>
        </div>
        
        <!-- USDT Input -->
        <div style="border: 1px solid #e5e7eb; background: white; border-radius: 10px; padding: 14px; margin-bottom: 16px;">
          <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
            <div style="display: flex; align-items: center; gap: 8px;">
              <div style="width: 28px; height: 28px; background: #14b8a6; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 12px; font-weight: bold;">₮</div>
              <span style="font-weight: 600; font-size: 0.9375rem; color: #111827;">USDT</span>
            </div>
            <input 
              type="number" 
              id="usdtInput"
              value="2740.31"
              step="0.01"
              style="font-size: 1.375rem; font-weight: 700; text-align: right; background: transparent; border: none; outline: none; width: 140px; color: #111827;"
            />
          </div>
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <div style="display: flex; gap: 4px;">
              <button onclick="setMultiplier(0)" style="font-size: 0.6875rem; padding: 3px 10px; background: #f9fafb; border-radius: 5px; border: 1px solid #e5e7eb; cursor: pointer; color: #6b7280; font-weight: 500;">0</button>
              <button onclick="setMultiplier(0.5)" style="font-size: 0.6875rem; padding: 3px 10px; background: #f9fafb; border-radius: 5px; border: 1px solid #e5e7eb; cursor: pointer; color: #6b7280; font-weight: 500;">50%</button>
              <button onclick="setMultiplier(1.0)" style="font-size: 0.6875rem; padding: 3px 10px; background: #f9fafb; border-radius: 5px; border: 1px solid #e5e7eb; cursor: pointer; color: #6b7280; font-weight: 500;">MAX</button>
            </div>
            <span style="font-size: 0.8125rem; color: #9ca3af; font-weight: 500;" id="usdtUsd">$2,740</span>
          </div>
        </div>
        
        <!-- Summary -->
        <div style="border-top: 1px solid #e5e7eb; padding-top: 16px; margin-bottom: 20px;">
          <div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
            <span style="font-size: 0.875rem; color: #6b7280;">Total deposit</span>
            <span style="font-weight: 700; font-size: 1.125rem;" id="totalDepositSide">$5,958</span>
          </div>
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <span style="font-size: 0.875rem; color: #6b7280;">Deposit ratio</span>
            <div style="display: flex; gap: 8px;">
              <span style="font-size: 0.875rem; font-weight: 500;">Ξ 54.01%</span>
              <span style="font-size: 0.875rem; font-weight: 500; color: #14b8a6;">₮ 45.99%</span>
            </div>
          </div>
        </div>
        
        <button style="width: 100%; background: #10b981; color: white; font-weight: 600; padding: 14px; border-radius: 10px; border: none; font-size: 0.9375rem; cursor: pointer; transition: background 0.2s;" onmouseover="this.style.background='#059669'" onmouseout="this.style.background='#10b981'">Add Liquidity</button>
      </div>
    </div>
  </div>

  <script>
    let priceRange={min:3165.29,max:3261.68},depositMultiplier=1.0,isDragging=null;
    const currentPrice=3210,viewport={priceMin:2000,priceMax:4500},baseWeth=1,baseUsdt=2740.31;
    const canvas=document.getElementById('gaugeCanvas'),ctx=canvas.getContext('2d');
    
    // Shared state via postMessage
    function sendStateUpdate(){
      if(window.parent!==window){
        window.parent.postMessage({type:'stateUpdate',state:{priceRange,depositMultiplier}},'*');
      }
    }
    window.addEventListener('message',e=>{
      if(e.data.type==='syncState'&&e.data.state){
        if(e.data.state.priceRange)priceRange=e.data.state.priceRange;
        if(e.data.state.depositMultiplier!==undefined)depositMultiplier=e.data.state.depositMultiplier;
      }
    });

    function calculateAPR(){
      const width=priceRange.max-priceRange.min;
      const pct=(width/currentPrice)*100;
      const base=127.2;
      const mult=Math.max(0.3,Math.min(3,10/pct));
      return Math.min(350,base*mult);
    }

    function calculateBalance(){
      const weth=baseWeth*depositMultiplier,usdt=baseUsdt*depositMultiplier;
      return weth*currentPrice+usdt;
    }

    function updateInputs(){
      const weth=(baseWeth*depositMultiplier).toFixed(2),usdt=(baseUsdt*depositMultiplier).toFixed(2);
      document.getElementById('wethInput').value=weth;
      document.getElementById('usdtInput').value=usdt;
      document.getElementById('wethUsd').textContent='$'+(weth*currentPrice).toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g,',');
      document.getElementById('usdtUsd').textContent='$'+parseFloat(usdt).toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g,',');
      document.getElementById('totalDepositSide').textContent='$'+calculateBalance().toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g,',');
    }

    function setMultiplier(v){depositMultiplier=v;updateInputs();sendStateUpdate();}
    function connectInputs(){
      const wi=document.getElementById('wethInput'),ui=document.getElementById('usdtInput');
      wi.addEventListener('input',e=>{
        const v=parseFloat(e.target.value)||0;depositMultiplier=v/baseWeth;updateInputs();sendStateUpdate();
      });
      ui.addEventListener('input',e=>{
        const v=parseFloat(e.target.value)||0;depositMultiplier=v/baseUsdt;updateInputs();sendStateUpdate();
      });
    }connectInputs();

    let randomSeed=42;function seededRandom(){randomSeed=(randomSeed*9301+49297)%233280;return randomSeed/233280;}
    function generateLiquidityCurve(n,cAng,r,cx,cy){
      const aStep=180/(n-1),curve=[];
      for(let i=0;i<n;i++){
        const a=-90+i*aStep,dist=Math.abs(a-cAng),peak=Math.exp(-dist*dist/800);
        const noise=(seededRandom()-0.5)*0.15,w1=Math.sin(i*0.15)*0.1,w2=Math.cos(i*0.08)*0.08;
        let h=0.4+peak*0.8+noise*1.5+w1*1.2+w2*1.1;
        h=Math.max(0.15,Math.min(1.2,h));
        const rad=(a-90)*Math.PI/180;
        curve.push({a,x:cx+r*Math.cos(rad),y:cy+r*Math.sin(rad),h});
      }return curve;
    }

    function resizeCanvas(){
      const r=canvas.getBoundingClientRect();
      canvas.width=r.width*window.devicePixelRatio;
      canvas.height=r.height*window.devicePixelRatio;
      ctx.scale(window.devicePixelRatio,window.devicePixelRatio);
    }resizeCanvas();window.addEventListener('resize',resizeCanvas);

    function priceToAngle(p){return -90+((p-viewport.priceMin)/(viewport.priceMax-viewport.priceMin))*180;}
    function angleToPrice(a){return viewport.priceMin+((a+90)/180)*(viewport.priceMax-viewport.priceMin);}
    function angleToPos(a,r,cx,cy){const rad=(a-90)*Math.PI/180;return{x:cx+r*Math.cos(rad),y:cy+r*Math.sin(rad)};}
    function posToAngle(x,y,cx,cy){const dx=x-cx,dy=y-cy;let a=Math.atan2(dy,dx)*180/Math.PI+90;if(a>180)a-=360;return Math.max(-90,Math.min(90,a));}

    function render(){
      const r=canvas.getBoundingClientRect(),w=r.width,h=r.height;
      ctx.clearRect(0,0,w,h);
      const cx=w/2,cy=h-30,rad=Math.min(w*0.4,h*0.75),thick=50;
      const curAng=priceToAngle(currentPrice),liq=generateLiquidityCurve(120,curAng,rad,cx,cy);
      const minA=priceToAngle(priceRange.min),maxA=priceToAngle(priceRange.max);

      ctx.shadowColor='rgba(255,100,60,0.25)';
      ctx.shadowBlur=8;
      for(let l=0;l<3;l++){
        const lr=rad-(thick/2)+(l*15);
        liq.forEach(pt=>{
          const inRange=pt.a>=minA&&pt.a<=maxA;
          const baseOp=inRange?0.45:0.1,op=baseOp-(l*0.05);
          const barH=pt.h*(0.9-l*0.2)*40;
          const col=inRange?`rgba(255,${150-l*20},${100-l*15},${op})`:`rgba(200,200,200,${op})`;
          ctx.strokeStyle=col;ctx.lineWidth=2;ctx.lineCap='round';
          const ang=(pt.a-90)*Math.PI/180,ir=lr-barH/2,or=lr+barH/2;
          ctx.beginPath();
          ctx.moveTo(cx+ir*Math.cos(ang),cy+ir*Math.sin(ang));
          ctx.lineTo(cx+or*Math.cos(ang),cy+or*Math.sin(ang));
          ctx.stroke();
        });
      }
      ctx.shadowBlur=0;

      ctx.beginPath();
      ctx.arc(cx,cy,rad,Math.PI,2*Math.PI);
      ctx.lineWidth=thick;
      ctx.lineCap='round';
      ctx.strokeStyle='rgba(243,244,246,0.5)';
      ctx.stroke();

      const sA=Math.PI+(minA+90)*Math.PI/180,eA=Math.PI+(maxA+90)*Math.PI/180;
      const grad=ctx.createLinearGradient(angleToPos(minA,rad,cx,cy).x,angleToPos(minA,rad,cx,cy).y,angleToPos(maxA,rad,cx,cy).x,angleToPos(maxA,rad,cx,cy).y);
      grad.addColorStop(0,'rgba(255,100,60,0.6)');
      grad.addColorStop(1,'rgba(255,140,80,0.6)');
      
      // Apply dynamic glow effect from enhancer
      if(enhancerActive){
        ctx.shadowColor=`rgba(255,120,80,${glowIntensity})`;
        ctx.shadowBlur=glowBlur;
      }
      
      ctx.beginPath();
      ctx.arc(cx,cy,rad,sA,eA);
      ctx.lineWidth=thick;
      ctx.lineCap='round';
      ctx.strokeStyle=grad;
      ctx.stroke();
      
      // Reset shadow
      if(enhancerActive){
        ctx.shadowBlur=0;
      }

      // current price line (straight line from center to arc)
      const curRad = rad + thick/2 + 20;
      const curRadians = (curAng - 90) * Math.PI / 180;
      const curPosX = cx + curRad * Math.cos(curRadians);
      const curPosY = cy + curRad * Math.sin(curRadians);
      ctx.beginPath();
      ctx.setLineDash([6,4]);
      ctx.moveTo(cx, cy);
      ctx.lineTo(curPosX, curPosY);
      ctx.strokeStyle='rgba(0,0,0,0.3)';
      ctx.lineWidth=2;
      ctx.stroke();
      ctx.setLineDash([]);

      // handles
      const drawHandle=(a,active)=>{
        const p=angleToPos(a,rad,cx,cy);
        ctx.beginPath();
        ctx.arc(p.x,p.y,active?18:16,0,Math.PI*2);
        ctx.fillStyle=active?'#6b7280':'#9ca3af';
        ctx.fill();
        ctx.strokeStyle='white';
        ctx.lineWidth=3;
        ctx.stroke();
        ctx.strokeStyle='rgba(255,255,255,0.6)';
        ctx.lineWidth=2;
        [-4, 0, 4].forEach(offset => {
          ctx.beginPath();
          ctx.moveTo(p.x + offset, p.y - 6);
          ctx.lineTo(p.x + offset, p.y + 6);
          ctx.stroke();
        });
      };

      drawHandle(priceToAngle(priceRange.min), isDragging === 'left');
      drawHandle(priceToAngle(priceRange.max), isDragging === 'right');

      // UI updates
      const balance = calculateBalance();
      const apr = calculateAPR();
      const inRange = currentPrice >= priceRange.min && currentPrice <= priceRange.max;

      document.getElementById('minPrice').textContent = priceRange.min.toFixed(2);
      document.getElementById('minPriceUsd').textContent = '$' + priceRange.min.toFixed(2);
      document.getElementById('maxPrice').textContent = priceRange.max.toFixed(2);
      document.getElementById('maxPriceUsd').textContent = '$' + priceRange.max.toFixed(2);
      document.getElementById('balancePercent').textContent = (depositMultiplier * 100).toFixed(0) + '%';
      document.getElementById('balanceUsd').textContent = '$' + balance.toFixed(0);
      document.getElementById('apr').textContent = apr.toFixed(2) + '%';
      
      updateInputs();

      const indicator = document.getElementById('aprIndicator');
      const status = document.getElementById('aprStatus');
      if (inRange) {
        indicator.classList.add('active');
        status.textContent = '✓ In range';
        status.style.color = '#10b981';
      } else {
        indicator.classList.remove('active');
        status.textContent = '○ Out of range';
        status.style.color = '#6b7280';
      }
    }

    // Mouse logic
    function getMouse(e) {
      const rect = canvas.getBoundingClientRect();
      return { x: e.clientX - rect.left, y: e.clientY - rect.top };
    }

    canvas.addEventListener('mousedown', e => {
      const { x, y } = getMouse(e);
      const r = canvas.getBoundingClientRect(), cx = r.width / 2, cy = r.height - 30;
      const radius = Math.min(r.width * 0.4, r.height * 0.75);
      const minA = priceToAngle(priceRange.min), maxA = priceToAngle(priceRange.max);
      const minPos = angleToPos(minA, radius, cx, cy);
      const maxPos = angleToPos(maxA, radius, cx, cy);

      const dMin = Math.hypot(x - minPos.x, y - minPos.y);
      const dMax = Math.hypot(x - maxPos.x, y - maxPos.y);

      if (dMin < 25) isDragging = 'left';
      else if (dMax < 25) isDragging = 'right';
    });

    canvas.addEventListener('mousemove', e => {
      if (!isDragging) return;
      const { x, y } = getMouse(e);
      const r = canvas.getBoundingClientRect(), cx = r.width / 2, cy = r.height - 30;
      const angle = posToAngle(x, y, cx, cy);
      const price = angleToPrice(angle);

      if (isDragging === 'left'){
        priceRange.min = Math.max(viewport.priceMin, Math.min(price, priceRange.max - 10));
        sendStateUpdate();
      }else if (isDragging === 'right'){
        priceRange.max = Math.min(viewport.priceMax, Math.max(price, priceRange.min + 10));
        sendStateUpdate();
      }
    });

    ['mouseup', 'mouseleave'].forEach(ev =>
      canvas.addEventListener(ev, () => (isDragging = null))
    );

    // Chart enhancer - smooth animations and polish
    let enhancerActive = false;
    let glowIntensity = 0;
    let glowBlur = 0;
    
    function initChartEnhancer() {
      if (enhancerActive) return;
      enhancerActive = true;
      let displayedAPR = calculateAPR();
      let frame = 0;
      
      function calculateGlow() {
        const apr = calculateAPR();
        const heat = Math.min(1, apr / 350);
        const glow = 4 + 8 * Math.sin(frame * 0.02);
        glowIntensity = 0.15 + heat * 0.2;
        glowBlur = glow * heat;
      }
      
      function shimmerGradient(width) {
        const shift = Math.sin(frame * 0.015) * 60;
        const g = ctx.createLinearGradient(shift, 0, width + shift, 0);
        g.addColorStop(0, 'rgba(255,130,80,0.25)');
        g.addColorStop(1, 'rgba(255,100,60,0.25)');
        return g;
      }
      
      function enhanceAnimate() {
        frame++;
        // Smooth APR number animation
        const targetAPR = calculateAPR();
        displayedAPR += (targetAPR - displayedAPR) * 0.08;
        const aprText = document.getElementById('apr');
        if (aprText) aprText.textContent = displayedAPR.toFixed(2) + '%';
        
        // Calculate glow effect (stored for render function)
        calculateGlow();
        
        // Update APR indicator glow intensity
        const indicator = document.getElementById('aprIndicator');
        if (indicator) {
          const glowLevel = Math.min(1, targetAPR / 350);
          indicator.style.boxShadow = `0 0 ${6 + glowLevel * 10}px rgba(16,185,129,${0.4 + glowLevel * 0.4})`;
        }
        
        requestAnimationFrame(enhanceAnimate);
      }
      
      enhanceAnimate();
    }
    
    function animate() {
      render();
      requestAnimationFrame(animate);
    }
    animate();
    
    // Start enhancer after initial render
    setTimeout(() => initChartEnhancer(), 100);
  </script>
</body>
</html>